{{ define "main" }}
<div class="contact-page">
  <div class="page-header">
    <h1 class="page-title">{{ .Title }}</h1>
  </div>
  
  <div class="contact-content">
    {{ .Content }}
    
    <form class="contact-form" id="contactForm" method="POST" onsubmit="return handleSubmit(event)">
      <div class="form-group">
        <label for="name">Your name</label>
        <input type="text" id="name" name="name" required>
      </div>
      
      <div class="form-group">
        <label for="email">Your email</label>
        <input type="email" id="email" name="email" required>
      </div>
      
      <div class="form-group">
        <label for="subject">Subject</label>
        <input type="text" id="subject" name="subject" required>
      </div>
      
      <div class="form-group">
        <label for="message">Your message</label>
        <textarea id="message" name="message" rows="5" required></textarea>
      </div>

      <!-- Honeypot field - hidden from users, catches bots -->
      <div class="form-group honeypot">
        <label for="website">Website</label>
        <input type="text" id="website" name="website" tabindex="-1" autocomplete="off">
      </div>

      <!-- Math CAPTCHA -->
      <div class="form-group">
        <label for="captcha">Security question: <span id="mathQuestion"></span></label>
        <input type="text" id="captcha" name="captcha" required placeholder="Enter your answer">
        <input type="hidden" id="captchaAnswer" name="captchaAnswer">
      </div>

      <button type="submit" class="submit-btn">Submit</button>
    </form>
  </div>
</div>

<div id="successModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>âœ“ Message Sent!</h3>
    <p>Thank you for contacting us. We will reply to you soon.</p>
    <button onclick="closeModal()" class="ok-btn">OK</button>
  </div>
</div>

<style>
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff;
  margin: 15% auto;
  padding: 30px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover { color: #000; }
.modal-content h3 {
  color: #4CAF50;
  margin-bottom: 15px;
}
.ok-btn {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 15px;
}
.ok-btn:hover { background-color: #45a049; }
.honeypot {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  overflow: hidden;
}
</style>

<script>
// Generate random math CAPTCHA on page load
window.addEventListener('DOMContentLoaded', function() {
  const num1 = Math.floor(Math.random() * 10) + 1;
  const num2 = Math.floor(Math.random() * 10) + 1;
  const answer = num1 + num2;

  document.getElementById('mathQuestion').textContent = 'What is ' + num1 + ' + ' + num2 + '?';
  document.getElementById('captchaAnswer').value = answer;
});
</script>

<script>
function handleSubmit(event) {
  event.preventDefault();

  const form = document.getElementById('contactForm');
  const submitButton = form.querySelector('.submit-btn');

  // Check honeypot - if filled, it's a bot
  const honeypot = document.getElementById('website').value;
  if (honeypot) {
    console.log('Bot detected via honeypot');
    return false;
  }

  // Validate CAPTCHA
  const userAnswer = document.getElementById('captcha').value;
  const correctAnswer = document.getElementById('captchaAnswer').value;

  if (userAnswer !== correctAnswer) {
    alert('Incorrect answer to the security question. Please try again.');
    return false;
  }

  // Disable button and show loading state
  submitButton.disabled = true;
  submitButton.textContent = 'Sending...';

  // Prepare form data as URL-encoded
  const formData = new FormData(form);
  const urlEncodedData = new URLSearchParams(formData).toString();

  // Send to email service
  fetch('/send-email.cgi', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: urlEncodedData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Email sent successfully');
      showModal();
      form.reset();
      // Generate new CAPTCHA
      const num1 = Math.floor(Math.random() * 10) + 1;
      const num2 = Math.floor(Math.random() * 10) + 1;
      const answer = num1 + num2;
      document.getElementById('mathQuestion').textContent = 'What is ' + num1 + ' + ' + num2 + '?';
      document.getElementById('captchaAnswer').value = answer;
    } else {
      alert('Failed to send message: ' + data.message + '\n\nPlease try again or contact us directly at wordofguidance@gmail.com');
    }
    submitButton.disabled = false;
    submitButton.textContent = 'Submit';
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to send message. Please try again or contact us directly at wordofguidance@gmail.com');
    submitButton.disabled = false;
    submitButton.textContent = 'Submit';
  });

  return false;
}

function showModal() {
  document.getElementById('successModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('successModal').style.display = 'none';
}
</script>
{{ end }}
